#!/usr/bin/env python3

import sys
from pathlib import Path
from datetime import datetime


def get_yoda_home():
    """Get yoda-home directory path."""
    return Path.home() / 'yoda-home'


def cmd_add(text):
    """Append timestamped entry to inbox.md."""
    yoda_home = get_yoda_home()

    if not yoda_home.exists():
        print(f"Error: {yoda_home} does not exist. Please create it first.", file=sys.stderr)
        sys.exit(1)

    inbox = yoda_home / 'inbox.md'

    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    entry = f"- [{timestamp}] {text}\n"

    with open(inbox, 'a') as f:
        f.write(entry)

    print("Added to inbox.md")


def cmd_search(query):
    """Search for query across all markdown files."""
    yoda_home = get_yoda_home()

    if not yoda_home.exists():
        print(f"Error: {yoda_home} does not exist. Please create it first.", file=sys.stderr)
        sys.exit(1)

    query_lower = query.lower()
    found = False

    for md_file in sorted(yoda_home.rglob('*.md')):
        try:
            with open(md_file, 'r', encoding='utf-8') as f:
                for line_num, line in enumerate(f, 1):
                    if query_lower in line.lower():
                        rel_path = md_file.relative_to(yoda_home)
                        print(f"{rel_path}:{line_num}:{line.rstrip()}")
                        found = True
        except Exception as e:
            print(f"Warning: Could not read {md_file.relative_to(yoda_home)}: {e}", file=sys.stderr)
            continue

    if not found:
        print("No matches found.")


def cmd_today():
    """Show today's log file and mentions of today's date in other files."""
    yoda_home = get_yoda_home()

    if not yoda_home.exists():
        print(f"Error: {yoda_home} does not exist. Please create it first.", file=sys.stderr)
        sys.exit(1)

    today = datetime.now().strftime('%Y-%m-%d')
    today_log = yoda_home / 'logs' / f'{today}.md'

    # Part A: Show today's log file
    print(f"=== Today's log ({today}) ===\n")
    if today_log.exists():
        with open(today_log, 'r', encoding='utf-8') as f:
            content = f.read()
            if content.strip():
                print(content)
            else:
                print("No log file for today")
    else:
        print("No log file for today")

    # Part B: Search for today's date in other files
    print(f"\n=== Other mentions of {today} ===\n")
    found = False

    for md_file in sorted(yoda_home.rglob('*.md')):
        # Skip today's log file
        if md_file == today_log:
            continue

        try:
            with open(md_file, 'r', encoding='utf-8') as f:
                for line_num, line in enumerate(f, 1):
                    if today in line:
                        rel_path = md_file.relative_to(yoda_home)
                        print(f"{rel_path}:{line_num}:{line.rstrip()}")
                        found = True
        except Exception as e:
            rel_path = md_file.relative_to(yoda_home)
            print(f"Warning: Could not read {rel_path}: {e}", file=sys.stderr)
            continue

    if not found:
        print("No other mentions found.")


def print_usage():
    """Print usage information."""
    print("yoda - minimal local-first CLI")
    print()
    print("Usage:")
    print('  yo add "text"       Append timestamped entry to inbox.md')
    print('  yo search "query"   Search across ~/yoda-home')
    print('  yo today            Show today\'s log and mentions')


def main():
    if len(sys.argv) < 2:
        print_usage()
        sys.exit(1)

    command = sys.argv[1]

    if command == 'add':
        if len(sys.argv) < 3:
            print('Usage: yo add "text"')
            sys.exit(1)
        cmd_add(' '.join(sys.argv[2:]))

    elif command == 'search':
        if len(sys.argv) < 3:
            print('Usage: yo search "query"')
            sys.exit(1)
        cmd_search(' '.join(sys.argv[2:]))

    elif command == 'today':
        cmd_today()

    else:
        print_usage()
        sys.exit(1)


if __name__ == '__main__':
    main()
